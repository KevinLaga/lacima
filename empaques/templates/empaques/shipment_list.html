{% if perms.empaques.view_shipment %}
{% load static %}
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Lista de Embarques</title>
  <link rel="stylesheet" href="{% static 'admin/css/base.css' %}">
</head>
<body>
  <!-- BOTÓN CERRAR SESIÓN (arriba derecha) -->
  <div class="logout-btn-wrap">
    <form method="post" action="{% url 'logout' %}">
      {% csrf_token %}
      <button type="submit" class="logout-btn" title="Cerrar sesión">⎋ Cerrar sesión</button>
    </form>
  </div>
  <style>
    .logout-btn-wrap { position: fixed; top: 12px; right: 12px; z-index: 9999; }
    .logout-btn { background: #ba2121; color: #fff; border: 0; border-radius: 6px;
      padding: .5rem .85rem; cursor: pointer; font-weight: 600; }
    .logout-btn:hover { opacity: .92; }
    table { border-collapse: collapse; }
    th, td { padding: 6px 10px; }
    select, input[type="week"], input[type="date"], input[type="number"], input[type="text"] {
      background: #fff; color: #000;
    }
    .form-inline { display:inline-block; margin-right:10px; margin-bottom: 8px; }
    .form-inline label { margin-right: 4px; }
  </style>

  <h1>Embarques Registrados</h1>
  <p><a href="{% url 'shipment_create' %}">+ Nuevo Embarque</a></p>

  <!-- Descarga por semana (input type="week" + empresa) -->
  <form method="get" class="form-inline">
    <label for="id_iso_week">Semana:</label>
    <input type="week" id="id_iso_week" name="iso_week"
           value="{{ request.GET.iso_week|default:'' }}" required>

    <label for="id_empresa_sem">Empresa:</label>
    <select id="id_empresa_sem" name="empresa">
      {% with e=request.GET.empresa|default:'general' %}
      <option value="general" {% if e == 'general' %}selected{% endif %}>General (todas)</option>
      <option value="La Cima Produce" {% if e == 'La Cima Produce' %}selected{% endif %}>La Cima Produce</option>
      <option value="RC Organics" {% if e == 'RC Organics' %}selected{% endif %}>RC Organics</option>
      <option value="GH Farms" {% if e == 'GH Farms' %}selected{% endif %}>GH Farms</option>
      <option value="Gourmet Baja Farms" {% if e == 'Gourmet Baja Farms' %}selected{% endif %}>Gourmet Baja Farms</option>
      <option value="GBF Farms" {% if e == 'GBF Farms' %}selected{% endif %}>GBF Farms</option>
      {% endwith %}
    </select>

    <button type="submit" name="descargar" value="semana">Descargar semana</button>
  </form>

  <!-- Descarga por rango de fechas -->
  <form method="get" class="form-inline">
    <label for="id_start">Rango:</label>
    <input type="date" id="id_start" name="start" value="{{ request.GET.start|default:'' }}" required>
    <span>—</span>
    <input type="date" id="id_end" name="end" value="{{ request.GET.end|default:'' }}" required>
    <button type="submit" name="descargar" value="rango">Descargar rango</button>
  </form>

  <!-- Formulario de descarga mensual (con empresa) -->
  <h3>Descargar resumen mensual</h3>
  <form method="get" action="{% url 'shipment_list' %}" class="form-inline">
    <input type="hidden" name="descargar" value="mes">
    <label for="year-mes">Año:</label>
    <input type="number" id="year-mes" name="year" min="2020" max="2100"
           value="{{ request.GET.year|default:today.year }}">
    <label for="month-mes">Mes:</label>
    <input type="number" id="month-mes" name="month" min="1" max="12"
           value="{{ request.GET.month|default:today.month }}">

    <label for="id_empresa_mes">Empresa:</label>
    <select id="id_empresa_mes" name="empresa">
      {% with e=request.GET.empresa|default:'general' %}
      <option value="general" {% if e == 'general' %}selected{% endif %}>General (todas)</option>
      <option value="La Cima Produce" {% if e == 'La Cima Produce' %}selected{% endif %}>La Cima Produce</option>
      <option value="RC Organics" {% if e == 'RC Organics' %}selected{% endif %}>RC Organics</option>
      <option value="GH Farms" {% if e == 'GH Farms' %}selected{% endif %}>GH Farms</option>
      <option value="Gourmet Baja Farms" {% if e == 'Gourmet Baja Farms' %}selected{% endif %}>Gourmet Baja Farms</option>
      <option value="GBF Farms" {% if e == 'GBF Farms' %}selected{% endif %}>GBF Farms</option>
      {% endwith %}
    </select>

    <button type="submit">Descargar Mes</button>
  </form>

  <!-- Formulario de descarga anual (con empresa) -->
  <h3>Descargar resumen anual</h3>
  <form method="get" action="{% url 'shipment_list' %}" class="form-inline">
    <input type="hidden" name="descargar" value="ano">
    <label for="year-ano">Año:</label>
    <input type="number" id="year-ano" name="year" min="2020" max="2100"
           value="{{ request.GET.year|default:today.year }}">

    <label for="id_empresa_ano">Empresa:</label>
    <select id="id_empresa_ano" name="empresa">
      {% with e=request.GET.empresa|default:'general' %}
      <option value="general" {% if e == 'general' %}selected{% endif %}>General (todas)</option>
      <option value="La Cima Produce" {% if e == 'La Cima Produce' %}selected{% endif %}>La Cima Produce</option>
      <option value="RC Organics" {% if e == 'RC Organics' %}selected{% endif %}>RC Organics</option>
      <option value="GH Farms" {% if e == 'GH Farms' %}selected{% endif %}>GH Farms</option>
      <option value="Gourmet Baja Farms" {% if e == 'Gourmet Baja Farms' %}selected{% endif %}>Gourmet Baja Farms</option>
      <option value="GBF Farms" {% if e == 'GBF Farms' %}selected{% endif %}>GBF Farms</option>
      {% endwith %}
    </select>

    <button type="submit">Descargar Año</button>
  </form>

  <!-- Buscador por tracking: abre el reporte específico -->
  <form method="get" action="{% url 'daily_report' %}" style="margin-bottom: 1rem;">
    <input type="text" name="tracking" placeholder="Buscar por N° de embarque..." />
    <button type="submit">Ir</button>
  </form>

  <!-- Tabla de embarques -->
  <table border="1" cellpadding="5" cellspacing="0">
    <thead>
      <tr>
        <th>#</th>
        <th>Embarque</th>
        <th>Factura</th>
        <th>Fecha</th>
        <th>Detalle</th>
        <!-- nuevas columnas por empresa -->
        <th>La Cima</th>
        <th>RC</th>
        <th>GH</th>
        <th>Gourmet</th>
        <th>GBF</th>
      </tr>
    </thead>
    <tbody>
    {% for s in shipments %}
      <tr>
        <td>{{ forloop.counter }}</td>
        <td>{{ s.tracking_number }}</td>
        <td>{{ s.invoice_number }}</td>
        <td>{{ s.date }}</td>
        <td>
          <a href="{% url 'daily_report' %}?date={{ s.date|date:'Y-m-d' }}">Ver día</a>
          &nbsp;|&nbsp;
          <a href="{% url 'daily_report' %}?shipment_id={{ s.id }}">Ver Reporte</a>
        </td>
        <td>{{ s.order_lacima|default_if_none:"" }}</td>
        <td>{{ s.order_rc|default_if_none:"" }}</td>
        <td>{{ s.order_gh|default_if_none:"" }}</td>
        <td>{{ s.order_gourmet|default_if_none:"" }}</td>
        <td>{{ s.order_gbf|default_if_none:"" }}</td>
      </tr>
    {% empty %}
      <tr><td colspan="10">No hay embarques aún.</td></tr>
    {% endfor %}
    </tbody>
  </table>
</body>
</html>
{% else %}
<p>No tienes permiso para ver embarques.</p>
{% endif %}
