{% load static %}
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Producción del día</title>

  <!-- Bootstrap + Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    /* ========= Producción Hoy ========= */
    body{background:#f6f8fb}
    .page-header{position:sticky;top:0;z-index:1020;background:#fff;border-bottom:1px solid rgba(0,0,0,.06)}
    .page-title{font-weight:700;letter-spacing:.2px}
    .subtle{color:#6c757d}
    .pill{display:inline-flex;align-items:center;gap:.35rem;padding:.25rem .6rem;border-radius:999px;font-size:.85rem;background:#f1f3f5;border:1px solid #e9ecef}
    .card-soft{border:1px solid rgba(0,0,0,.06);border-radius:14px;background:#fff}
    .table thead th{position:sticky;top:0;background:#1f4f86;color:#fff; z-index:5}
    .table thead th, .table tbody td{vertical-align:middle}
    .num{ text-align:right }
    .w-qty{ max-width:110px }
    .td-empaque{ min-width:220px }
    .chips-scroll{white-space:nowrap;overflow:auto}
    .savebar{position:sticky;bottom:0;z-index:1020;background:#fffffff7;border-top:1px solid rgba(0,0,0,.08);backdrop-filter: blur(6px)}
    .help-tiny{font-size:.8rem;color:#6c757d}
  </style>
</head>
<body>

  <!-- Header -->
  <div class="page-header">
    <div class="container-fluid py-3">
      <div class="d-flex flex-wrap align-items-center gap-3">
        <h1 class="mb-0 page-title">Producción del día – {{ prod_date|date:"d/m/Y" }}</h1>
        <span class="pill">Empresa: <strong class="ms-1">{{ empresa }}</strong></span>
        <div class="ms-auto d-flex flex-wrap gap-2">
          <a class="btn btn-outline-secondary btn-sm" href="{% url 'production_days' %}?empresa={{ empresa|lower }}">
            <i class="bi bi-clock-history me-1"></i> Días guardados
          </a>
          <a class="btn btn-primary btn-sm" href="{% url 'shipment_create' %}">
            <i class="bi bi-box-seam me-1"></i> Nuevo embarque
          </a>
          <a class="btn btn-success btn-sm" href="{% url 'production_xlsx' prod_date=prod_date|date:'Y-m-d' %}?empresa={{ empresa|lower }}">
            <i class="bi bi-file-earmark-excel me-1"></i> Descargar Excel
          </a>
        </div>
      </div>

      <!-- Filtros rápidos -->
      <form class="row g-2 mt-2" method="get" action="{% url 'production_today' %}">
        <div class="col-12 col-md-auto">
          <label class="form-label mb-0 subtle">Fecha</label>
          <input type="date" class="form-control" name="date" value="{{ prod_date|date:'Y-m-d' }}">
        </div>
        <div class="col-12 col-md-auto">
          <label class="form-label mb-0 subtle">Empresa</label>
          <select class="form-select" name="empresa">
            {% for c in empresas %}
              <option value="{{ c|lower }}" {% if empresa == c %}selected{% endif %}>{{ c }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-12 col-md-auto d-flex align-items-end">
          <button class="btn btn-outline-primary"><i class="bi bi-arrow-right-circle me-1"></i> Ir</button>
        </div>
      </form>
    </div>
  </div>

  <div class="container-fluid my-3">

    <!-- Embarques del día -->
    <div class="card-soft p-3 mb-3">
      <div class="d-flex flex-wrap align-items-center gap-2">
        <span class="subtle"><b>Embarques del día ({{ empresa }}):</b></span>
        <div class="chips-scroll d-flex gap-2">
          {% if ship_cols_labels and ship_cols_labels|length %}
            {% for sid in ship_cols_labels %}
              <span class="pill"><i class="bi bi-truck me-1"></i>{{ sid }}</span>
            {% endfor %}
          {% else %}
            <span class="subtle">(no hay)</span>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Formulario principal -->
    <form method="post">
      {% csrf_token %}
      <input type="hidden" name="empresa" value="{{ empresa|lower }}">

      <!-- Meta de la orden -->
      <div class="card-soft p-3 mb-3">
        <div class="row g-3">
          <div class="col-12 col-md-4">
            <label class="form-label"><b>No. de orden</b></label>
            <input type="text" name="order_number" value="{{ order_number|default:'' }}" class="form-control" placeholder="Ej. PO-12345">
          </div>
          <div class="col-12 col-md-8 d-flex align-items-end">

          </div>
        </div>
      </div>

      <!-- Tabla -->
      <div class="card-soft p-0 mb-3">
        <div class="table-responsive">
          <table class="table table-sm table-hover align-middle mb-0">
            <thead>
              <tr>
                <th class="text-start">Empaque</th>
                <th class="num">Exist. anterior</th>
                <th class="num">Prod. día</th>
                <th class="num">Exist. almacén</th>
                <th class="num">Emb. 1</th>
                <th class="num">Emb. 2</th>
                <th class="num">Emb. 3</th>
                <th class="num">Emb. 4</th>
                <th class="num">Debe</th>
                <th class="num">Pago</th>
                <th class="num">Presto</th>
                <th class="num">Le pagaron</th>
              </tr>
            </thead>
            <tbody>
              {% for r in rows %}
              <tr>
                <!-- Empaque -->
                <td class="text-start td-empaque">
                  <div class="fw-semibold">{{ r.pres }}</div>
                  <div class="subtle">{{ r.size }}</div>
                </td>

                <!-- Existencia anterior (solo lectura) -->
                <td class="num">{{ r.exist_prev }}</td>

                <!-- Producción del día (solo lectura) -->
                <td class="num">{{ r.prod_dia }}</td>

                <!-- Existencia en almacén (editable) -->
                <td class="num">
                  <input type="number" step="1" class="form-control form-control-sm w-qty"
                         name="{{ r.form_prefix }}__exist_almacen" value="{{ r.exist_almacen }}">
                </td>

                <!-- Embarques del día (solo lectura) -->
                <td class="num">{{ r.per_ship.0|default:"0" }}</td>
                <td class="num">{{ r.per_ship.1|default:"0" }}</td>
                <td class="num">{{ r.per_ship.2|default:"0" }}</td>
                <td class="num">{{ r.per_ship.3|default:"0" }}</td>

                <!-- Manuales (editables) -->
                <td class="num">
                  <input type="number" step="1" class="form-control form-control-sm w-qty"
                         name="{{ r.form_prefix }}__debe" value="{{ r.debe }}">
                </td>
                <td class="num">
                  <input type="number" step="1" class="form-control form-control-sm w-qty"
                         name="{{ r.form_prefix }}__pago" value="{{ r.pago }}">
                </td>
                <td class="num">
                  <input type="number" step="1" class="form-control form-control-sm w-qty"
                         name="{{ r.form_prefix }}__presto" value="{{ r.presto }}">
                </td>
                <td class="num">
                  <input type="number" step="1" class="form-control form-control-sm w-qty"
                         name="{{ r.form_prefix }}__le_pagaron" value="{{ r.le_pagaron }}">
                </td>
              </tr>
              {% empty %}
              <tr><td colspan="12" class="text-center subtle py-4">(Sin filas)</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <!-- Resumenes -->
      <div class="row g-3">
        <div class="col-12 col-xl-6">
          <div class="card-soft p-3 h-100">
            <div class="mb-2"><b>Existencia piso día anterior:</b> <span>{{ exist_piso_ayer|default:0 }}</span></div>

            <div class="mb-2">
              <label class="form-label"><b>Cajas de campo recibidas</b></label>
              <input type="number" name="cajas_campo_recibidas" value="{{ cajas_campo_recibidas|default:0 }}" step="1" min="0" class="form-control w-qty">
            </div>

            <div class="mb-2"><b>Total cajas a trabajar:</b> <span>{{ total_cajas_trabajar|default:0 }}</span></div>

            <div class="mb-2">
              <label class="form-label"><b>Existencia de piso hoy</b></label>
              <input type="number" name="exist_piso_hoy" value="{{ exist_piso_hoy|default:0 }}" step="1" min="0" class="form-control w-qty">
            </div>

            <div class="mb-1"><b>Cajas campo trabajadas:</b> <span>{{ cajas_campo_trabajadas|default:0 }}</span></div>
          </div>
        </div>

        <div class="col-12 col-xl-6">
          <div class="card-soft p-3 h-100">
            <h5 class="mb-3">Acumulados de temporada</h5>

            <div class="row g-3">
              <div class="col-12">
                <label class="form-label"><strong>Total de cajas de campo cosechadas (acumulado hasta AYER)</strong></label>
                <input type="number" name="acum_cosechadas_ayer" step="1"
                      value="{{ acum_cosechadas_ayer|default:0 }}"
                      class="form-control w-qty">
                <div class="help-tiny">Solo el primer día. Después se toma automático del día anterior.</div>
              </div>
              <div class="col-12">
                <label class="form-label"><strong>Total de cajas empacadas (acumulado hasta AYER, Eq. 11 lb)</strong></label>
                <input type="number" name="acum_empacadas_ayer" step="0.01"
                      value="{{ acum_empacadas_ayer|default:0 }}"
                      class="form-control w-qty">
                <div class="help-tiny">Solo el primer día. Después se toma automático del día anterior.</div>
              </div>
            </div>

            <hr class="my-3">



      <!-- Barra guardar -->
      <div class="savebar mt-3">
        <div class="container-fluid py-2 d-flex align-items-center gap-2">
          <div class="subtle">Revisa los valores editables y guarda para aplicar cambios.</div>
          <button type="submit" class="btn btn-success ms-auto">
            <i class="bi bi-save me-1"></i> Guardar
          </button>
        </div>
      </div>
    </form>

  </div>

  <!-- Bootstrap JS (solo si lo necesitas para tooltips/dropdowns) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
